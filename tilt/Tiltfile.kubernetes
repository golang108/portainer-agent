load('ext://restart_process', 'docker_build_with_restart')

# For some reason, tiltfile doesn't support a pattern like /**/*.go for deps. It does for ignore though!? 
local_resource(
  'build_agent',
  cmd="make agent",
  deps=['*.go', 
    'agent.go',
    'build',
    'chisel',
    'cmd',
    'config',
    'constants',
    'crypto',
    'dist',
    'docker',
    'edge',
    'exec',
    'filesystem',
    'ghw',
    'healthcheck',
    'http',
    'internals',
    'kubernetes',
    'net',
    'nomad',
    'os',
    'release.sh',
    'serf',
    'static'
  ],
  ignore=[
    'dist', 
    '/**/*_test.go'
  ],
)

# can be a local registry or this temporary one.  Change yourname and randomstring to suit your needs
default_registry('ttl.sh/yourname-randomstring')

docker_build_with_restart('portainer_agent', 
  '.',
  entrypoint='./agent',
  dockerfile='build/linux/alpine.Dockerfile',
  only = ['dist', 'build', 'static', 'config'],  
  live_update = [
    sync('./dist', '/app'),
    sync('./static', '/app/static'),
  ])

k8s_yaml('portainer-agent-k8s-lb.yaml')
